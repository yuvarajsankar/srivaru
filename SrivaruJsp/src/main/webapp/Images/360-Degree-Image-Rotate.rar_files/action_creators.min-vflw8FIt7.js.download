define(["require","exports","external/react","external/lodash","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/analytics","modules/clean/annotations/annotation","modules/clean/comments/action_creators_helpers","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/logged_out_utils","modules/clean/comments/models/comment_activity","modules/clean/comments/revisions","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/file_activity/api","modules/clean/file_activity/clients/file_activity_data_source","modules/clean/immutability_helper","modules/clean/react/file_comments/onboarding","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_viewer/utils","modules/clean/react/modal","modules/clean/revisions/file_revisions_iterator","modules/clean/storage","modules/constants/comments_panel","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/react/file_viewer/data/legacy_flux_integration","modules/clean/comments/models/comment","modules/clean/file_activity/models/file_activity"],function(t,e,n,o,i,a,r,s,c,m,l,u,d,v,y,g,f,C,_,p,h,I,x,A,b,w,S,K,L,V){"use strict";function O(){var t=y.state.actorId,e=y.state.shouldShowOnboarding,n=y.state.viewing,o=n.context,i=n.file,a=I.getFileViewerInterfaceType(o,i&&i.preview_type);if(null!=t&&null!=a){if(null==e)return f.shouldShowCommentingOnboarding({actorId:t}).then(function(t){if(m.setShouldShowOnboarding(t),t)return Q()}).catch(function(){});if(e===!0)return Q()}}function T(t,e){return void 0!==t&&null!==t?e(t):void 0}var k=function(t,e){var n=C.getInstance().commitOptimisticUpdate(e);return t.then(function(t){return C.getInstance().rebase(n),t}),t.catch(function(t){return C.getInstance().rollbackOptimisticUpdate(n),Promise.reject(t)})},E=function(t){var e=t.targetActivityKey,n=t.pendingCommentActivity,o=y.state.activity.activity_key,i=e===o?null:e,a=n.comment,r=a.raw_comment_text,s=a.comment_metadata,c=f.addComment({actorId:y.state.actorId,context:y.state.viewing.context,contextData:y.state.viewing.contextData,commentActivityKey:i,text:r,metadata:null!=s?s.toDict():void 0,oref:y.state.oref}),m=C.getInstance().commitOptimisticUpdate(function(t){return t.appendComment(e,n)});return c.then(function(t){var n=C.getInstance();return n.rollbackOptimisticUpdate(m),n.rebase(function(n){return n.appendComment(e,t)})}),[c,m]},U=function(t,e){return _.merge(t,{status:"FAILED",activity_key:e})},R=function(t){var e=t.targetActivityKey,n=t.body,o=t.annotation,i=g.getActivityUser(y.state.actorId);y.state.activity.activity_key;var a=null!=n.text?n.text:"",r=c.buildCommentMetadata(n,o),s=d.CommentActivity.createLocalInstance({commenter:i,rawCommentText:a,metadata:r,status:"POSTING"}),m=Array.from(E({targetActivityKey:e,pendingCommentActivity:s})),l=m[0],u=m[1];return l.catch(function(t){var n=C.getInstance();return n.rollbackOptimisticUpdate(u),n.commitOptimisticUpdate(function(t,n){var o=U(s,n);return t.appendComment(e,o)}),Promise.reject(t)}),[s,l]},B=function(t,e,n){var o=g.getActivityUser(y.state.actorId),r=y.state.activity.activity_key;if(!o.is_signed_in)return u.saveActionCreator({name:t,fileActivityKey:r,args:e}),l.CommentsEvents.emit("show-sign-up-modal",{fileActivityKey:r,variant:h.CommentsSharedLinkSignupModals.POST_COMMENT_VARIANT}),u.logSignUpModal({fileActivityKey:r,commentActivityKey:n,originType:w.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.POST_BUTTON}),b.LocalStorage.set("tmp-file-comment",null),!1;if(!o.is_email_verified){var s=i.EmailVerification.get_for_user(o);return i.EmailVerification.set_should_use_simple_ui(!1),s.show_verify_modal(null,a.ADD_COMMENT),!1}return!0},P=function(t){var e=t.targetActivityKey,n=t.pendingCommentActivity;r.CommentsVortexLogger.log("retry-post-attempt"),C.getInstance().rollbackOptimisticUpdate(n.activity_key),n=n.setStatus("POSTING");var o=Array.from(E({targetActivityKey:e,pendingCommentActivity:n})),i=o[0],a=o[1];return i.catch(function(t){var o=C.getInstance();return o.rollbackOptimisticUpdate(a),o.commitOptimisticUpdate(function(t){var o=U(n,a);return t.appendComment(e,o)}),Promise.reject(t)}),m.addedComment(),i.then(function(){return r.CommentsVortexLogger.log("retry-post-success")})},D=function(t){if(B("addFileComment",[t])){r.CommentsVortexLogger.log("add-comment-attempt");var e=y.state.activity.activity_key,n=Array.from(R({targetActivityKey:e,body:t})),o=n[1];return m.addedComment(),o.then(function(){return r.CommentsVortexLogger.log("add-comment-success")})}},N=function(t){var e=y.state.createAnnotation.annotation;if(null!=e&&B("addInlineAnnotation",[t])){r.CommentsVortexLogger.log("add-annotation-attempt");var n=Array.from(R({targetActivityKey:y.state.activity.activity_key,body:t,annotation:e})),o=n[0],i=n[1];return M(o),m.addedComment(),i.then(function(){return r.CommentsVortexLogger.log("add-annotation-success")})}},F=function(t){var e=t.targetActivityKey,n=t.body;if(B("addReply",[{targetActivityKey:e,body:n}])){r.CommentsVortexLogger.log("add-reply-attempt");var o=Array.from(R({targetActivityKey:e,body:n})),i=o[0],a=o[1];return M(i),m.addedComment(),a.then(function(){return r.CommentsVortexLogger.log("add-reply-success")})}},M=function(t){return o.defer(function(){return H({activityKey:t.activity_key,expandConversation:!1})})},G=function(t){var e=t.commentActivityKey;r.CommentsVortexLogger.log("delete-comment-attempt"),S.assert(null!=y.state.activity.findCommentByKey(e),"Comment activity to delete does not exist: "+e);var n=f.deleteComment({actorId:y.state.actorId,context:y.state.viewing.context,contextData:y.state.viewing.contextData,commentActivityKey:e,oref:y.state.oref});return k(n,function(t){return t.purgeCommentByKey(e)}),n.then(function(){return r.CommentsVortexLogger.log("delete-comment-success")})},Y=function(t){var e,n=t.commentActivityKey,o=t.resolved;r.CommentsVortexLogger.log("set-resolved-attempt");var i=y.state.activity.findCommentByKey(n);S.assert(null!=i,"Comment activity to resolve/unresolve does not exist: "+n);var a=f.updateResolveComment({actorId:y.state.actorId,context:y.state.viewing.context,contextData:y.state.viewing.contextData,commentActivityKey:n,resolved:o,oref:y.state.oref});return e=i.comment.resolved?function(t){return t.unresolveCommentByKey(n)}:function(t){return t.resolveCommentByKey(n)},k(a,e),a.then(function(){return r.CommentsVortexLogger.log("set-resolved-success")})},j=function(t){var e,n=t.enabled;r.CommentsVortexLogger.log("set-enabled-attempt");var o=f.updateCommentSetting({actorId:y.state.actorId,context:y.state.viewing.context,contextData:y.state.viewing.contextData,enableComment:n,oref:y.state.oref});return e=y.state.activity.feedback_off?function(t){return t.enableCommenting()}:function(t){return t.disableCommenting()},k(o,e),n?m.enableCommenting():m.disableCommenting(),o.then(function(){return r.CommentsVortexLogger.log("set-enabled-success")})},W=function(t){var e=t.subscribed,n=g.getActivityUser(y.state.actorId),o=y.state.activity.activity_key;if(!n.is_signed_in)return u.saveActionCreator({name:"setCommentSubscribed",fileActivityKey:o,args:arguments.slice()}),l.CommentsEvents.emit("show-sign-up-modal",{fileActivityKey:o,variant:h.CommentsSharedLinkSignupModals.SUBSCRIBE_VARIANT}),void u.logSignUpModal({fileActivityKey:o,originType:w.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.SUBSCRIBE_BUTTON});if(!n.is_email_verified){var s=i.EmailVerification.get_for_user(n);return i.EmailVerification.set_should_use_simple_ui(!1),void s.show_verify_modal(null,a.SUBSCRIBE_TO_COMMENTS)}r.CommentsVortexLogger.log("set-subscribed-attempt");var c=f.updateFileActivitySubscription({actorId:y.state.actorId,context:y.state.viewing.context,contextData:y.state.viewing.contextData,subscribed:e,oref:y.state.oref});return e?c.then(function(){return L.Notify.success(K._("You have been subscribed."))}).catch(function(t){return L.Notify.error(K._("We failed to unsubscribe you.")),Promise.reject(t)}):c.then(function(){return L.Notify.success(K._("You have been unsubscribed."))}).catch(function(t){return L.Notify.error(K._("We failed to unsubscribe you.")),Promise.reject(t)}),c.then(function(){return r.CommentsVortexLogger.log("set-subscribe-success")})},q=function(t){var e=y.state.activity,n=e.findConversationByKey(t),i=g.getActivityUser(y.state.actorId);if(null!=n&&i.is_signed_in){var a=function(t){return!(t.is_pending||t.is_seen)},s=n.comment_activities.filter(a);if(a(n)&&s.push(n),s.length>0){r.CommentsVortexLogger.log("mark-conversation-seen-attempt");var c=o.map(s,"activity_key"),m=f.markCommentSeenBatch({isBackgroundRequest:!0,actorId:y.state.actorId,context:y.state.viewing.context,contextData:y.state.viewing.contextData,commentActivityKeys:c});return k(m,function(t){return e.markCommentSeenByKeyBatch(c)}),m.then(function(){return r.CommentsVortexLogger.log("mark-conversation-seen-success")})}}},H=function(t){var e=t.activityKey,n=t.expandConversation;return l.CommentsEvents.emit("reveal-comment-in-pane",{activityKey:e,expandConversation:n})},z=function(t){var e=y.state.activity;if(null!=e){var n=e.findConversationByKey(t);if(T(null!=n?n.comment.comment_metadata:void 0,function(t){return t.annotation})){var o=n.comment.comment_metadata,i=o.annotation,a=o.revision,r=s.Annotation.createAnnotationFromDict(i);return null!=a&&m.switchRevision({revision:a,commentActivity:n}),l.CommentsEvents.emit("reveal-annotation",{page:r.getFirstPdfPage(),commentActivity:n})}}},J=function(t){var e=y.state.activity,n=g.getActivityUser(y.state.actorId);if(y.state.viewing.file&&e&&t&&v.isRevisionOlderThan(e.latest_revision,t.latest_revision)){var o=v.getFileWithRevision(y.state.viewing.file,t.latest_revision);V.reduxSaveForwardRevision(t.latest_revision.revision_id,o)}if(m.receiveFileActivity(t),n.is_signed_in&&null==e&&null!=t&&u.replayActionCreators({actionCreators:nt,fileActivityKey:t.activity_key}),y.state.isPreviewReady&&null==e)return l.CommentsEvents.emit("preview-and-comments-ready")},Q=function(){var t=y.state.actorId,e=n.createElement(p,{onOpen:function(){return m.setShouldShowOnboarding(!1),f.markCommentingOnboardingSeen({actorId:t}).catch(function(){})}});return x.Modal.showInstance(e)},X=function(){if(r.CommentsVortexLogger.log("show-comments-attempt"),y.areCommentsHidden())return $(!0),m.showComments(),r.CommentsVortexLogger.log("show-comments-success")},Z=function(){if(r.CommentsVortexLogger.log("hide-comments-attempt"),!y.areCommentsHidden())return $(!1),m.hideComments(),r.CommentsVortexLogger.log("hide-comments-success")},$=function(t){return null!=y.state.actorId?f.setCommentingPaneVisibility({actorId:y.state.actorId,shouldShow:t}):f.setSessionCommentingPaneVisibility({shouldShow:t})},tt=function(){return f.setShowCommentsTutorial({actorId:y.state.actorId,shouldShow:!1})},et=function(t){return new A.FileRevisionsIterator(t,y.state.actorId).next().then(function(t){return m.receiveRevisions(t.revisions)})};l.CommentsEvents.on("file-activity-updated",J);var nt=o.assignIn({},m,{addReply:F,addFileComment:D,addInlineAnnotation:N,retryPostingComment:P,deleteComment:G,setCommentResolved:Y,setCommentSubscribed:W,setCommentsEnabled:j,markConversationSeen:q,showOnboardingIfNecessary:O,revealCommentInPane:H,revealAnnotationInPreview:z,markCommentsTutorialAsDone:tt,showComments:X,hideComments:Z,fetchRevisions:et});return nt});
//# sourceMappingURL=action_creators.min.js-vflEzkjMe.map