define(["require","exports","external/lodash","modules/clean/annotations/annotation","modules/clean/comments/revisions","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/constants/comments_panel","modules/core/exception"],function(t,n,o,e,i,a,r,s,c,l,h){"use strict";var v=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui","mouse-up"],u=function(t){return t=t.replace(/(\-\w)/g,function(t){return t[1].toUpperCase()}),t.slice(0,1).toUpperCase()+t.slice(1)},d=l.ALLOW_ANNOTATION_GHOST;return(function(){function t(t){var n=t.prevState,o=t.state,e=t.interfaceController,i=t.actionCreators;this.onStateChange=this.onStateChange.bind(this),this.onAnnotationHidden=this.onAnnotationHidden.bind(this),this.onAnnotationPlaced=this.onAnnotationPlaced.bind(this),this.onAnnotationStartDrag=this.onAnnotationStartDrag.bind(this),this.onAnnotationEndDrag=this.onAnnotationEndDrag.bind(this),this.onAnnotationUiClick=this.onAnnotationUiClick.bind(this),this.onAnnotationUiEnter=this.onAnnotationUiEnter.bind(this),this.onAnnotationUiLeave=this.onAnnotationUiLeave.bind(this),this.onScaleChange=this.onScaleChange.bind(this),this.onScroll=this.onScroll.bind(this),this.onOnKeydown=this.onOnKeydown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onResetFileFeedbackUi=this.onResetFileFeedbackUi.bind(this),this.prevState=n,this.state=o,this.interfaceController=e,this.actionCreators=i}return t.create=function(n){return new t({prevState:{activityKeys:[],hasEphemeral:!1},state:{ephemeralAnnotation:null,commentActivityByKey:{},canAnnotate:!1,regionCreationEnabled:!1,viewingAnnotationConversation:!1},interfaceController:null,actionCreators:n})},t.prototype.setState=function(t){return o.assignIn(this.state,t),this.performUpdateIfNecessary()},t.prototype.getStateFromStores=function(){var t,n=a.state.showResolvedComments;return t=r.shouldShowExistingAnnotations()?a.state.activity.comment_activities.filter(function(t){return t.comment.resolved,null!=(null!=t.comment.comment_metadata?t.comment.comment_metadata.annotation:void 0)}):{},{activityKey:null!=a.state.activity?a.state.activity.activity_key:void 0,actorId:a.state.actorId,activityContext:a.state.viewing.context,revision:a.state.viewing.revision,commentActivityByKey:o.keyBy(t,"activity_key"),ephemeralAnnotation:null!=a.state.createAnnotation?a.state.createAnnotation.annotation:void 0,canAnnotate:r.canAnnotate(),regionCreationEnabled:r.isRegionCreationEnabled(),showResolved:n,viewingAnnotationConversation:null!=a.state.viewAnnotation}},t.prototype.onStateChange=function(){if(null!=a.state.activity)return this.setState(this.getStateFromStores())},t.prototype.mount=function(t){return h.assert(null!=t,"Interface controller must not be null"),h.assert(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(a.state),this.unsubscribeStore=a.listen(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary()},t.prototype.unmount=function(){return h.assert(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},t.prototype.isMounted=function(){return null!=this.interfaceController},t.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},t.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},t.prototype.enableRegionCreation=function(){return this.interfaceController.dispatchEvent("enable-region-creation")},t.prototype.disableRegionCreation=function(){return this.interfaceController.dispatchEvent("disable-region-creation")},t.prototype.addAnnotationEventListeners=function(){var t=this;return v.forEach(function(n){var o="on"+u(n),e=t[o];if(null!=e)return t.interfaceController.addListener(n,e)})},t.prototype.removeAnnotationEventListeners=function(){var t=this;return v.forEach(function(n){var o="on"+u(n),e=t[o];if(null!=e)return t.interfaceController.removeListener(n,e)})},t.prototype.onAnnotationHidden=function(t){return this.actionCreators.stopAnnotationCreation()},t.prototype.onAnnotationPlaced=function(t){var n=e.Annotation.createAnnotationFromDict(t.annotation);return this.actionCreators.startAnnotationCreation({annotation:n}),c.log_annotation_event(l.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},t.prototype.onAnnotationStartDrag=function(t){return this.actionCreators.hideAnnotationConversation(),this.actionCreators.hideAnnotationInput()},t.prototype.onAnnotationEndDrag=function(t){this.actionCreators.hideAnnotationConversation();var n=e.Annotation.createAnnotationFromDict(t.annotation);return this.actionCreators.startAnnotationCreation({annotation:n}),c.log_annotation_event(l.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},t.prototype.onAnnotationUiClick=function(t){var n=t.commentActivity.activity_key;return this.actionCreators.revealAnnotationInPreview(n),this.actionCreators.revealCommentInPane({activityKey:n,expandConversation:!1}),c.log_annotation_event(l.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=t.commentActivity?t.commentActivity.activity_key:void 0,this.state.actorId,this.state.activityContext)},t.prototype.onAnnotationUiEnter=function(t){if(null==this.state.ephemeralAnnotation&&(null==a.state.viewAnnotation||!a.state.viewAnnotation.replyFocused))return this.actionCreators.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:e.Annotation.createAnnotationFromDict(t.annotation)}),c.log_annotation_event(l.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=t.commentActivity?t.commentActivity.activity_key:void 0,this.state.actorId,this.state.activityContext)},t.prototype.onAnnotationUiLeave=function(t){var n=this;if(this.actionCreators.updateAnnotationUiHover(!1),null==this.state.ephemeralAnnotation&&(null==a.state.viewAnnotation||!a.state.viewAnnotation.replyFocused)){var o=function(){if(n.isMounted()&&!(null!=a.state.viewAnnotation?a.state.viewAnnotation.conversationHover:void 0)&&!(null!=a.state.viewAnnotation?a.state.viewAnnotation.annotationHover:void 0))return n.actionCreators.hideAnnotationConversation()};return window.setTimeout(o,50)}},t.prototype.onScaleChange=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},t.prototype.onScroll=function(t){var n=this;this.actionCreators.hideAnnotationInput(),this.actionCreators.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer);var i=o.partial(function(t){if(null!=(null!=t?t.annotation:void 0)){var o=e.Annotation.createAnnotationFromDict(t.annotation);return n.actionCreators.startAnnotationCreation({annotation:o})}return n.actionCreators.showAnnotationInput()},t);return this.annotationBubbleTimer=window.setTimeout(i,150)},t.prototype.onOnKeydown=function(t){if(r.normalizedKeyCode.apply(t)===s.KeyCode.ESC)return this.actionCreators.stopAnnotationCreation()},t.prototype.onMouseUp=function(t){if(null!=this.state.viewingAnnotationConversation)return this.actionCreators.hideAnnotationConversation()},t.prototype.onResetFileFeedbackUi=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},t.prototype._savePrevState=function(){return this.prevState={activityKeys:Object.keys(null!=this.state.commentActivityByKey?this.state.commentActivityByKey:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate,regionCreationEnabled:this.state.regionCreationEnabled,viewingAnnotationConversation:this.state.viewingAnnotationConversation}},t.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},t.prototype._updateAnnotations=function(t){for(var n=[],o=0,e=0,a=Array.from(t);e<a.length;e++){var r=a[e];if(r.comment.hasMetadata()&&r.comment.comment_metadata.hasAnnotationData()&&(o+=1,this.state.showResolved||!r.comment.resolved)){var s=r.comment.comment_metadata,c=s.annotation,l=s.revision,h=i.isRevisionEqual(this.state.revision,l);if(d||null!=l&&h){var v=d&&null!=l&&!h;n.push({annotation:c,commentActivity:r,options:{isGhostAnnotation:v,isAnnotationNumberingEnabled:!0,annotationNumber:o}})}}}return this.interfaceController.dispatchEvent("update-annotations",{annotations:n})},t.prototype.performUpdateIfNecessary=function(){if(this.isMounted()){if(o.isEmpty(this.state.commentActivityByKey))this.interfaceController.dispatchEvent("remove-all-annotations");else{o.difference(null!=this.prevState.activityKeys?this.prevState.activityKeys:[],Object.keys(this.state.commentActivityByKey)).forEach(this._removeAnnotation,this),this._updateAnnotations(o.values(this.state.commentActivityByKey))}return this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),this.prevState.regionCreationEnabled!==this.state.regionCreationEnabled&&(this.state.regionCreationEnabled?this.enableRegionCreation():this.disableRegionCreation()),this.prevState.viewingAnnotationConversation!==this.state.viewingAnnotationConversation&&(this.state.viewingAnnotationConversation?this.disableRegionCreation():this.state.regionCreationEnabled&&this.enableRegionCreation()),this._savePrevState()}},t})()});
//# sourceMappingURL=file_preview_annotations.min.js-vflV9L2lT.map